<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="icon" href="Ez_haiim.png" type="image/x-icon"/>
        <title>Чтение Торы API data</title>
        <style>
            html {
                font-size: 150%;
                color: #4a4a4a;
            }
            div {
                width: 300px;
                border-collapse: collapse;
                border: 2px solid rgb(200,200,200);
                letter-spacing: 1px;
                font-size: 0.8rem;
                margin: 10px;
                text-align: center;
            }
            p {
                margin: 8px;
            }
            h1 {
                font-size: 120%;
            }
        </style>
    </head>
    <body>
        <div>
            <p><h1>Чтение Торы на этой неделе</h1><p>
            
        </div>
        <script>
            let div = document.querySelector('div');
            let today = new Date('2021-09-16');
            let year = today.getFullYear();
            let month = today.getMonth() + 1;
            let dateToday = today.getDate();
            
            let engRus = new Map([
                ['Exodus', 'Исход'],
                ['Ezekiel', 'Иезекииль'],
                ['Moshe', 'Моисей'],
                ['Numbers', 'Числа'],
                ['Hosea', 'Осия'],
                ['Judges', 'Судьи'],
                ['Isaiah', 'Исайя'],
                ['Deuteronomy', 'Второзаконие'],
                ['Jeremiah', 'Иеремия'],
                ['Leviticus', 'Левит'],
                ['II Samuel', 'II-e Царств'],
                ['I Samuel', 'I-e Царств'],
                ['Genesis', 'Бытие'],
                ['I Kings', 'III-e Царств'],
                ['II Kings', 'IV-e Царств'],
                ['Malachi', 'Малaхии'],
                ['Joshua', 'Иисус Навин'],
                ['Amos', 'Амос'],
                ['Habakkuk', 'Аввакум'],
                ['Zechariah', 'Захария'],
                ['Micah', 'Михей'],
                ['Joel', 'Иоиля'],
                ['Obadiah', 'Авдия'],
                ['Shabbat Rosh Chodesh', 'Шаббат Рош Ходеш (начало месяца)']
            ]);

            function getTorahReading() {            
                fetch('https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&min=on&year='+year+'&ss=on&s=on&lg=ru&city=DE-Berlin').then(function(response) {
                    response.json().then(function(json) {
                        let items = json.items; 
                        getResult();
            
                        function getResult() {
                            for (var i = 0; i < items.length; i++) {

                                let date = items[i].date;          
                                let dateFromJson = new Date(date);

                                let dayDifference = Math.floor((today - dateFromJson)/(24*60*60*1000));
                                
                                let title = items[i].title;

                                let haftarah = null;
                                if (undefined !== items[i].leyning) {
                                    haftarah = items[i].leyning.haftarah;
                                }

                                let torah = null;
                                if (undefined !== items[i].leyning) {
                                    torah = items[i].leyning.torah;
                                }

                                let translationsArray = null;
                                let readyTorahString = '<b>Тора:</b>';
                                let readyHaftarahString = '<b>Хавтара:</b>';
                                if (items[i].category === 'parashat' && dayDifference <= 0 && dayDifference >= -6) {
                                    showTorahReading(dateFromJson, title);
                                    showParashaAndCandle(buildReadyString(translate(torah), readyTorahString));
                                    showParashaAndCandle(buildReadyString(translate(haftarah), readyHaftarahString));
                                } else if (items[i].category === 'holiday' && dayDifference === 0) {
                                    showTorahReading(dateFromJson, title);
                                    showParashaAndCandle(buildReadyString(translate(torah), readyTorahString));
                                    showParashaAndCandle(buildReadyString(translate(haftarah), readyHaftarahString));
                                }
                            }
                        }   
                    });
                });
            }

            function getCandleLighting() {            
                fetch('https://www.hebcal.com/shabbat?v=1&cfg=json&lg=ru&city=DE-Munich&gy='+year+'&gm='+month+'&gd='+dateToday).then(function(response) {
                    response.json().then(function(json) {
                        let items = json.items; 
                        getResult();
            
                        function getResult() {
                            for (var i = 0; i < items.length; i++) {

                                let date = items[i].date;          
                                let candleDate = new Date(date);

                                let correctCandleDate = candleDate.toISOString().split('T')[0];
                                let todayDate = today.toISOString().split('T')[0];

                                if (correctCandleDate === todayDate && items[i].category === 'candles') {
                                    showParashaAndCandle('<b>Зажигание свечей: </b><br>' + showTime(candleDate));
                                }
                            }
                        }   
                    });
                });
            }

            function translate(originalString) {
                if (null === originalString) {
                    return;
                }

                let translatedString = '';
                let originalArray = originalString.split(';');
                for (var i = 0; i < originalArray.length; i++) {
                    let originalWord = originalArray[i].slice(0, originalArray[i].search(/\d+/)).trim();
                    if (engRus.get(originalWord)) {
                        translatedString += originalArray[i].replace(originalWord, engRus.get(originalWord)).split('|')[0] + '<br>';
                    }
                }

                return translatedString;
            }

            function showTime(originalDate){
                let dateDay = originalDate.getDate();
                if (dateDay < 10) {
                    dateDay = '0' + dateDay;
                }

                let dateMonth = originalDate.getMonth() + 1;
                if (dateMonth < 10) {
                    dateMonth = '0' + dateMonth;
                }

                let dateYear = originalDate.getFullYear();

                let dateHours = originalDate.getHours();
                if (dateHours < 10) {
                    dateHours = '0' + dateHours;
                }

                let dateMinutes = originalDate.getMinutes();
                if (dateMinutes < 10) {
                    dateMinutes = '0' + dateMinutes;
                }

                return newDateString = dateDay + '.' + dateMonth + '.' + dateYear + ' ' + ' в ' + dateHours + ':' + dateMinutes;
            }

            function showParashaAndCandle(originalString) {
                if (originalString === undefined) {
                    return;
                }
                let newString = document.createElement('p');
                newString.innerHTML = originalString;
                newString.style.textAlign = 'left';
                div.appendChild(newString);
            }

            function showTorahReading(dateFromJson, title) {
                
                let newParaDate = document.createElement('p');
                newParaDate.textContent = showTime(dateFromJson).split(' ')[0];
                newParaDate.style.color = 'green';
                div.appendChild(newParaDate); 

                let newParaTitel = document.createElement('p');
                newParaTitel.textContent = title;
                newParaTitel.style.fontWeight = 'bolder';
                div.appendChild(newParaTitel);
            }

            function getLinkBible(originalString) {
                let arrayBible = new Map([
                    ['Exodus', 'Исход'],
                    ['Ezekiel', 'Иезекииль'],
                    ['Moshe', 'Моисей'],
                    ['Числа', 'nu'],
                    ['Осия', 'ho'],
                    ['Judges', 'Судьи'],
                    ['Isaiah', 'Исайя'],
                    ['Второзаконие', 'de'],
                    ['Jeremiah', 'Иеремия'],
                    ['Левит', 'le'],
                    ['II-e Царств', '2ki'],
                    ['I-e Царств', '1ki'],
                    ['Бытие', 'ge'],
                    ['III-e Царств', '3ki'],
                    ['IV-e Царств', '4ki'],
                    ['Malachi', 'Малaхии'],
                    ['Joshua', 'Иисус Навин'],
                    ['Amos', 'Амос'],
                    ['Habakkuk', 'Аввакум'],
                    ['Zechariah', 'Захария'],
                    ['Михей', 'mic'],
                    ['Иоиля', 'joe'],
                    ['Obadiah', 'Авдия'],
                ]);
                let link = '<a href="[BIBLE_LINK]" target="_blank">' + originalString + '</a>';
                let linkBible = 'https://allbible.info/bible/sinodal/';
                    
                let catWord = originalString.slice(0, originalString.search(/\d+/)).trim();

                searchWord = arrayBible.get(catWord );

                let regex = /\d+/g;
                let searchNumber = originalString.match(regex);

                let finalNumber = searchNumber[0];
                    
                let finalLink = linkBible + searchWord + '/' + finalNumber;
             
                return link.replace('[BIBLE_LINK]', finalLink)
            }

            function buildReadyString(stringToProcess, stringBeginning) {
                if (stringToProcess === undefined) {
                    return;
                }

                let readyString = stringBeginning;
                translationsArray = stringToProcess.split('<br>');
                translationsArray.forEach(function callback (value, key) {
                    if (value === '') {
                        return;
                    }
                    readyString = readyString + '<br>' + getLinkBible(value);
                });

                return readyString;
            }

            getTorahReading();
            getCandleLighting();
        </script>
    </body>
</html>